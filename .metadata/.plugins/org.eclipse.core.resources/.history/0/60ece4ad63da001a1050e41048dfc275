package com.hcl.order.service;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Objects;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.hcl.order.dao.OrderItemRepository;
import com.hcl.order.dao.OrderRepository;
import com.hcl.order.dto.OrderDto;
import com.hcl.order.dto.OrderItemDto;
import com.hcl.order.entity.Order;
import com.hcl.order.entity.OrderItem;
import com.hcl.order.feignclient.OrderItemServiceFeignClient;

@Service
public class OrderService {
	
	@Autowired
	private OrderRepository orderRepository;
	
	@Autowired
	private OrderItemRepository orderItemRepository;
	
	@Autowired(required=true)
	private OrderItemServiceFeignClient orderItemsServiceFeignClient;
	
	public void createOrder(OrderDto orderDto) {
	
	List<OrderItemDto> orderItemsDtos=orderItemsServiceFeignClient.listOrderItems();
	List<OrderItemDto> orderedItemsDtos=new ArrayList<>();
	
	for(OrderItemDto orderItemDto:orderItemsDtos)
		if(orderItemDto.getOrderItemId()==orderDto.getOrderItemId())
		orderedItemsDtos.add(orderItemDto);
	
	if(Objects.nonNull(orderDto))
	{
		Order order=new Order();
		order.setCustomerName(orderDto.getCustomerName());
		order.setOrderDate(orderDto.getOrderDate());
		order.setShippingAddress(orderDto.getShippingAddress());
		order.setTotal(orderDto.getTotal());
		order=orderRepository.save(order);
	    
	    OrderItem orderItem=new OrderItem();
	    for(OrderItemDto orderItemDto:orderedItemsDtos) {
	    orderItem.setOrderItemId(orderItemDto.getOrderItemId());
	    orderItem.setProductCode(orderItemDto.getProductCode());
	    orderItem.setProductName(orderItemDto.getProductName());
	    orderItem.setQuantity(orderItemDto.getQuantity());
	    }
	    orderItem.setOrder(order);
	    
	    orderItem=orderItemRepository.save(orderItem);
	    
		}
	
	}
	
	public List<OrderDto> ordersList(){
		
		Iterable<Order> ordersList=orderRepository.findAll();
		List<OrderDto> orderDtos = new ArrayList<>();
		
		for(Order order: ordersList) {
			OrderDto orderDto = new OrderDto();
			orderDto.setOrderId(order.getOrderId());
			orderDto.setCustomerName(order.getCustomerName());
			orderDto.setOrderDate(order.getOrderDate());
			orderDto.setShippingAddress(order.getShippingAddress());
			orderDto.setTotal(order.getTotal());
			orderDto.setOrderItemId(order.getOrderItems().iterator().next().getOrderItemId());
			orderDto.getOrderItems().setOrderItemId(order.getOrderItems().iterator().next().getOrderItemId());
			orderDto.getOrderItems().setProductName(order.getOrderItems().iterator().next().getProductName());
			orderDto.getOrderItems().setProductCode(order.getOrderItems().iterator().next().getProductCode());
			orderDto.getOrderItems().setQuantity(order.getOrderItems().iterator().next().getQuantity());
			orderDtos.add(orderDto);
		}
		
		return orderDtos;
	}
	
}
